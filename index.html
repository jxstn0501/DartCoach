<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>🏹 DartsCoach Full</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{background:#121212;color:#eee;font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px}
    h1{color:#ffcc00}
    .card{background:#1e1e1e;border:1px solid #333;border-radius:10px;padding:16px;margin:12px 0}
    button{background:#ffcc00;border:none;border-radius:8px;padding:10px 14px;font-weight:bold;cursor:pointer}
    .mono{white-space:pre-wrap;background:#111;border:1px solid #333;border-radius:8px;padding:10px;font-family:monospace}
    .ok{color:#30d158}.err{color:#ff453a}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #333;padding:6px;text-align:center}
    th{background:#2a2a2a}
  </style>
</head>
<body>
  <h1>🏹 DartsCoach (Full-Version)</h1>

  <!-- Config -->
  <div class="card">
    <h2>🔑 Konfiguration</h2>
    <p>API-Keys im Code hinterlegen.</p>
    <div id="cfgStatus" class="ok">✓ Keys geladen</div>
  </div>

  <!-- OCR -->
  <div class="card">
    <h2>📤 Screenshot importieren & OCR</h2>
    <input type="file" id="fileInput" accept="image/*" />
    <button id="btnOCR">OCR starten</button>
    <div id="ocrStatus" style="margin-top:8px"></div>
    <div id="ocrText" class="mono" style="margin-top:10px;min-height:120px">
      OCR-Ergebnis erscheint hier…
    </div>
  </div>

  <!-- Dashboard -->
  <div class="card">
    <h2>📊 Dashboard</h2>
    <canvas id="scoreChart" height="120"></canvas>
    <div id="roundTable"></div>
  </div>

  <!-- Trainingsplan -->
  <div class="card">
    <h2>🎯 Trainingsplan</h2>
    <button id="btnPlan">Trainingsplan erstellen</button>
    <button id="btnNotion">Nach Notion senden</button>
    <div id="planOut" class="mono" style="margin-top:10px;min-height:200px">
      Hier erscheint dein Trainingsplan…
    </div>
  </div>

  <script>
    /***************
     * CONFIG
     ***************/
    const CONFIG = {
      OPENAI_API_KEY: "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",
      NOTION_API_KEY: "ntn_K59984412336U5L12FBf7D9XSdOJVnbYWZMs1bTHswR72m",
      NOTION_DATABASE_ID: "26016588f31180099413d2ebd9ccbe38",
      OCR_BACKEND: "https://visionnow-81553987588.europe-west1.run.app/"
    };

    const $ = sel => document.querySelector(sel);

    /***************
     * OCR & FILE
     ***************/
    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result.split(',')[1]);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    async function runOCR(base64){
      const res = await fetch(CONFIG.OCR_BACKEND, {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ imageBase64: base64 })
      });
      const json = await res.json();
      if(json.error) throw new Error(json.error);
      return json?.textAnnotations?.[0]?.description 
          || json?.fullTextAnnotation?.text 
          || JSON.stringify(json,null,2);
    }

    /***************
     * PARSER
     ***************/
    function pointsOfToken(tok){
      const t = String(tok).toUpperCase().trim();
      if(/^T(\d{1,2})$/.test(t)) return 3*parseInt(t.slice(1),10);
      if(/^D(\d{1,2})$/.test(t)) return 2*parseInt(t.slice(1),10);
      if(/^(S)?(\d{1,2})$/.test(t)) return parseInt(t.replace('S',''),10);
      if(["BULL","DBULL","BULLSEYE","50"].includes(t)) return 50;
      if(["25","OBULL"].includes(t)) return 25;
      if(["MISS","0","-"].includes(t)) return 0;
      return NaN;
    }

    function parseDartsSmart(line,expected){
      let tokens=(line.match(/\b(T\d{1,2}|D\d{1,2}|\d{1,3}|25|50|BULL|MISS)\b/ig)||[]);
      if(tokens.length>=3) return tokens.slice(0,3);
      while(tokens.length<3) tokens.push("0");
      return tokens;
    }

    function parseDartsmind(ocrText){
      const lines=ocrText.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const rounds=[]; let currentStart=501;
      for(let i=0;i<lines.length;i++){
        const m=lines[i].match(/^RUNDE\s+(\d+)/i); if(!m) continue;
        const r=parseInt(m[1],10); const block=[]; let j=i+1;
        while(j<lines.length && !/^RUNDE\s+\d+/i.test(lines[j])){block.push(lines[j]);j++;}
        i=j-1;
        const nums=block.filter(x=>/^\d{1,3}$/.test(x));
        const score=nums.length?parseInt(nums[nums.length-1],10):null;
        const dartsLine=block.find(x=>/[TD]?\d+/.test(x))||"";
        const darts=parseDartsSmart(dartsLine,score);
        const roundScore=darts.reduce((a,t)=>a+(pointsOfToken(t)||0),0);
        const bust=/BUST/i.test(block.join(" "));
        const end=bust?currentStart:Math.max(currentStart-roundScore,0);
        rounds.push({round:r,start:currentStart,darts,score:roundScore,bust,end});
        currentStart=end;
      }
      return {rounds};
    }

    /***************
     * DASHBOARD
     ***************/
    function renderDashboard(parsed){
      if(!parsed?.rounds?.length){$("#roundTable").innerHTML="Keine Daten.";return;}
      // Chart
      const ctx=$("#scoreChart");
      new Chart(ctx,{type:"line",data:{
        labels:parsed.rounds.map(r=>"R"+r.round),
        datasets:[{label:"Score",data:parsed.rounds.map(r=>r.score)}]
      },options:{plugins:{legend:{labels:{color:"#eee"}}},scales:{x:{ticks:{color:"#eee"}},y:{ticks:{color:"#eee"}}}}});

      // Tabelle
      let html="<table><tr><th>Runde</th><th>Start</th><th>Darts</th><th>Score</th><th>Bust</th><th>Ende</th></tr>";
      parsed.rounds.forEach(r=>{
        html+=`<tr><td>${r.round}</td><td>${r.start}</td><td>${r.darts.join(", ")}</td><td>${r.score}</td><td>${r.bust?"✅":"❌"}</td><td>${r.end}</td></tr>`;
      });
      html+="</table>";
      $("#roundTable").innerHTML=html;
    }

    /***************
     * TRAININGSPLAN (GPT + Notion)
     ***************/
    async function buildTrainingPlan(parsed){
      const lastRounds=parsed.rounds.slice(-5);
      const prompt=`Analysiere folgende Darts-Daten (letzte ${lastRounds.length} Runden) und erstelle einen detaillierten Trainingsplan im unten gezeigten Format:\n\n${JSON.stringify(lastRounds,null,2)}`;
      const res=await fetch("https://api.openai.com/v1/chat/completions",{
        method:"POST",
        headers:{Authorization:`Bearer ${CONFIG.OPENAI_API_KEY}`,"Content-Type":"application/json"},
        body:JSON.stringify({
          model:"gpt-4o-mini",
          messages:[{role:"system",content:"Du bist ein Darts-Trainer."},{role:"user",content:prompt}]
        })
      });
      const data=await res.json();
      return data.choices?.[0]?.message?.content || JSON.stringify(data,null,2);
    }

    async function sendToNotion(planText){
      const res=await fetch("https://api.notion.com/v1/pages",{
        method:"POST",
        headers:{
          "Authorization":`Bearer ${CONFIG.NOTION_API_KEY}`,
          "Content-Type":"application/json",
          "Notion-Version":"2022-06-28"
        },
        body:JSON.stringify({
          parent:{database_id:CONFIG.NOTION_DATABASE_ID},
          properties:{Name:{title:[{text:{content:"Darts Trainingsplan"}}]}},
          children:[{object:"block",type:"paragraph",paragraph:{text:[{type:"text",text:{content:planText}}]}}]
        })
      });
      if(!res.ok) throw new Error(await res.text());
      return await res.json();
    }

    /***************
     * EVENTS
     ***************/
    let lastParsed=null;
    window.addEventListener('DOMContentLoaded',()=>{
      $("#btnOCR").onclick=async()=>{
        $("#ocrStatus").textContent="⏳ OCR läuft…";
        const f=$("#fileInput").files?.[0]; if(!f){$("#ocrStatus").innerHTML="<span class='err'>Bitte Screenshot auswählen.</span>";return;}
        try{
          const b64=await fileToBase64(f);
          const text=await runOCR(b64);
          $("#ocrText").textContent=text;
          lastParsed=parseDartsmind(text);
          renderDashboard(lastParsed);
          $("#ocrStatus").innerHTML="<span class='ok'>✓ OCR & Parser fertig</span>";
        }catch(e){$("#ocrStatus").innerHTML=`<span class='err'>Fehler: ${e.message}</span>`;}
      };

      $("#btnPlan").onclick=async()=>{
        if(!lastParsed){$("#planOut").textContent="Keine Daten";return;}
        $("#planOut").textContent="⏳ Generiere Trainingsplan…";
        try{
          const plan=await buildTrainingPlan(lastParsed);
          $("#planOut").textContent=plan;
        }catch(e){$("#planOut").textContent="Fehler: "+e.message;}
      };

      $("#btnNotion").onclick=async()=>{
        const plan=$("#planOut").textContent.trim();
        if(!plan){alert("Kein Plan vorhanden");return;}
        try{
          const resp=await sendToNotion(plan);
          alert("Plan nach Notion gesendet ✅");
        }catch(e){alert("Notion Fehler: "+e.message);}
      };
    });
  </script>
</body>
</html>