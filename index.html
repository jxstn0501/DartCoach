<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>üèπ DartsCoach Debug</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{background:#121212;color:#eee;font-family:Arial,Helvetica,sans-serif;margin:0;padding:20px}
    h1{color:#ffcc00}
    .card{background:#1e1e1e;border:1px solid #333;border-radius:10px;padding:16px;margin:12px 0}
    button{background:#ffcc00;border:none;border-radius:8px;padding:10px 14px;font-weight:bold;cursor:pointer}
    .mono{white-space:pre-wrap;background:#111;border:1px solid #333;border-radius:8px;padding:10px;font-family:monospace}
    .ok{color:#30d158}.err{color:#ff453a}
  </style>
</head>
<body>
  <h1>üèπ DartsCoach (Debug-Version)</h1>

  <div class="card">
    <h2>üîë Konfiguration</h2>
    <p>API-Key ist schon im Code eingetragen.</p>
    <div id="cfgStatus" class="ok">‚úì Vision API Key geladen</div>
  </div>

  <div class="card">
    <h2>üì§ Screenshot importieren & OCR</h2>
    <input type="file" id="fileInput" accept="image/*" />
    <button id="btnOCR">OCR starten</button>
    <div id="ocrStatus" style="margin-top:8px"></div>
    <div id="ocrText" class="mono" style="margin-top:10px;min-height:120px">
      OCR-Ergebnis erscheint hier‚Ä¶
    </div>
  </div>

  <script>
    /***************
     * KONFIG      *
     ***************/
    const CONFIG = {
      VISION_API_KEY: "AIzaSyAg3Vtec5ota1LYC5URMLjHz8Y-IhogQyc" // <-- dein Key
    };

    /***************
     * HELPERS     *
     ***************/
    const $ = sel => document.querySelector(sel);

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result.split(',')[1]);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    /***************
     * OCR LOGIK   *
     ***************/
async function runOCR(base64){
  const res = await fetch("https://visionnow-81553987588.europe-west1.run.app/", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ imageBase64: base64 })
  });

  const json = await res.json();
  console.log("Antwort von Cloud Run:", json);

  if (json.error) {
    return `‚ùå Fehler: ${json.error}`;
  }

  const text = json?.textAnnotations?.[0]?.description 
            || json?.fullTextAnnotation?.text 
            || JSON.stringify(json, null, 2);

  return text;
}  

 /***************
     * EVENTS      *
     ***************/
    window.addEventListener('DOMContentLoaded', ()=>{
      $("#btnOCR").onclick = async ()=>{
        $("#ocrStatus").textContent = "‚è≥ OCR l√§uft‚Ä¶";
        const f = $("#fileInput").files?.[0];
        if (!f){ $("#ocrStatus").innerHTML = `<span class="err">Bitte Screenshot ausw√§hlen.</span>`; return; }

        try{
          const b64 = await fileToBase64(f);
          const text = await runOCR(b64);
          $("#ocrText").textContent = text;
          $("#ocrStatus").innerHTML = `<span class="ok">‚úì OCR fertig</span>`;
        }catch(e){
          $("#ocrStatus").innerHTML = `<span class="err">Fehler: ${e.message}</span>`;
        }
      };
    });

    /***************
     * DEBUG HOOK  *
     ***************/
    window.onerror = (msg, src, line, col, err) => {
      alert("JS-Fehler: " + msg + " @ " + line + ":" + col);
    };
  </script>
</body>
</html>